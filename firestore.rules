rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function para validar usuario autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function para obtener tenant del usuario
    function getUserTenant() {
      return request.auth.token.tenantId;
    }
    
    // Helper function para obtener marca del usuario
    function getUserMarca() {
      return request.auth.token.marcaId;
    }
    
    // Reglas para RQs
    match /rqs/{rqId} {
      // Permitir lectura si el user pertenece a la misma marca
      allow read: if isAuthenticated() && 
                     resource.data.marcaId == getUserMarca();
      
      // Permitir creación si el user está autenticado y es Store Manager o Admin
      allow create: if isAuthenticated() &&
                       request.resource.data.marcaId == getUserMarca() &&
                       request.resource.data.tenantId == getUserTenant() &&
                       (request.auth.token.role == 'store_manager' || 
                        request.auth.token.role == 'brand_admin' ||
                        request.auth.token.role == 'brand_recruiter');
      
      // Permitir actualización si el user pertenece a la misma marca
      allow update: if isAuthenticated() && 
                       resource.data.marcaId == getUserMarca();
      
      // No permitir delete por ahora (solo soft delete cambiando estado)
      allow delete: if false;
    }
    
    // Reglas para otras collections (permitir temporalmente para desarrollo)
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
