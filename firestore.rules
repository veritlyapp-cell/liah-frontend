rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserTenant() {
      return request.auth.token.holdingId;
    }
    
    function getUserMarca() {
      return request.auth.token.marcaId;
    }
    
    function getUserRole() {
      return request.auth.token.role;
    }
    
    function isAdmin() {
      return getUserRole() in ['super_admin', 'client_admin', 'brand_admin'];
    }
    
    function isRecruiter() {
      return getUserRole() in ['recruiter', 'brand_recruiter'];
    }
    
    function isStoreManager() {
      return getUserRole() == 'store_manager';
    }
    
    function isSupervisor() {
      return getUserRole() == 'supervisor';
    }
    
    // ==========================================
    // RQs (Requerimientos)
    // ==========================================
    match /rqs/{rqId} {
      allow read: if isAuthenticated() && 
                     (isAdmin() || resource.data.marcaId == getUserMarca());
      
      allow create: if isAuthenticated() &&
                       request.resource.data.holdingId == getUserTenant() &&
                       (isStoreManager() || isSupervisor() || isAdmin());
      
      allow update: if isAuthenticated() && 
                       (isAdmin() || resource.data.marcaId == getUserMarca());
      
      allow delete: if false; // Solo soft delete
    }
    
    // ==========================================
    // CANDIDATES
    // ==========================================
    match /candidates/{candidateId} {
      // Lectura: Admin ve todo, otros solo de su marca
      allow read: if isAuthenticated() && 
                     (isAdmin() || 
                      resource.data.applications[0].marcaId == getUserMarca());
      
      // Crear: Cualquier autenticado (registro p√∫blico) o admin
      allow create: if isAuthenticated();
      
      // Actualizar: Admin, Recruiter de la marca, o el propio candidato
      allow update: if isAuthenticated() && 
                       (isAdmin() || 
                        isRecruiter() ||
                        resource.data.applications[0].marcaId == getUserMarca());
      
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // USER ASSIGNMENTS
    // ==========================================
    match /userAssignments/{userId} {
      allow read: if isAuthenticated() && 
                     (isAdmin() || request.auth.uid == userId);
      
      allow create, update: if isAuthenticated() && isAdmin();
      
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // HOLDINGS (Empresas)
    // ==========================================
    match /holdings/{holdingId} {
      allow read: if isAuthenticated() && 
                     (isAdmin() || getUserTenant() == holdingId);
      
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // MARCAS (Brands)
    // ==========================================
    match /marcas/{marcaId} {
      allow read: if isAuthenticated() && 
                     (isAdmin() || getUserMarca() == marcaId || 
                      resource.data.holdingId == getUserTenant());
      
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // TIENDAS (Stores)
    // ==========================================
    match /tiendas/{tiendaId} {
      allow read: if isAuthenticated() && 
                     (isAdmin() || 
                      resource.data.marcaId == getUserMarca() ||
                      resource.data.holdingId == getUserTenant());
      
      allow create, update: if isAuthenticated() && 
                               (isAdmin() || isStoreManager());
      
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // JOB PROFILES
    // ==========================================
    match /job_profiles/{profileId} {
      allow read: if isAuthenticated();
      
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    match /jobProfiles/{profileId} {
      allow read: if isAuthenticated();
      
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // VACANTES
    // ==========================================
    match /vacantes/{vacanteId} {
      allow read: if isAuthenticated();
      
      allow create, update: if isAuthenticated() && 
                               (isAdmin() || isStoreManager() || isRecruiter());
      
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // BLACKLIST
    // ==========================================
    match /blacklist/{entryId} {
      allow read: if isAuthenticated() && (isAdmin() || isRecruiter());
      
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // APPROVAL CONFIGS
    // ==========================================
    match /approvalConfigs/{configId} {
      allow read: if isAuthenticated();
      
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }
    
    // ==========================================
    // CATCH-ALL: Allow authenticated (TEMPORARY)
    // TODO: Define explicit rules for remaining collections
    // ==========================================
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}
